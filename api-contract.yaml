openapi: 3.1.0
info:
  title: Routa.js API Contract
  description: |
    Single source of truth for the Routa.js dual-backend API.
    Both the Next.js backend (src/app/api/) and the Rust backend (crates/routa-server/)
    MUST implement all endpoints defined here with compatible request/response shapes.
  version: 0.1.0

servers:
  - url: http://localhost:3000
    description: Next.js backend (dev)
  - url: http://localhost:3210
    description: Rust backend (desktop)

# ─────────────────────────────────────────────────────────
# Shared component schemas
# ─────────────────────────────────────────────────────────
components:
  schemas:
    # ── Enums ──
    AgentRole:
      type: string
      enum: [ROUTA, CRAFTER, GATE, DEVELOPER]

    ModelTier:
      type: string
      enum: [SMART, BALANCED, FAST]

    AgentStatus:
      type: string
      enum: [PENDING, ACTIVE, COMPLETED, ERROR, CANCELLED]

    TaskStatus:
      type: string
      enum: [PENDING, IN_PROGRESS, REVIEW_REQUIRED, COMPLETED, NEEDS_FIX, BLOCKED, CANCELLED]

    VerificationVerdict:
      type: string
      enum: [APPROVED, NOT_APPROVED, BLOCKED]

    NoteType:
      type: string
      enum: [spec, task, general]

    WorkspaceStatus:
      type: string
      enum: [active, archived]

    CodebaseSourceType:
      type: string
      enum: [local, github]

    VirtualFileEntry:
      type: object
      required: [path, name, isDirectory]
      properties:
        path:
          type: string
        name:
          type: string
        isDirectory:
          type: boolean
        size:
          type: integer
        children:
          type: array
          items:
            $ref: "#/components/schemas/VirtualFileEntry"

    # ── Models ──
    Agent:
      type: object
      required: [id, name, role, modelTier, workspaceId, status, createdAt, updatedAt, metadata]
      properties:
        id:
          type: string
        name:
          type: string
        role:
          $ref: "#/components/schemas/AgentRole"
        modelTier:
          $ref: "#/components/schemas/ModelTier"
        workspaceId:
          type: string
        parentId:
          type: string
        status:
          $ref: "#/components/schemas/AgentStatus"
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        metadata:
          type: object
          additionalProperties:
            type: string

    Task:
      type: object
      required: [id, title, objective, status, dependencies, workspaceId, createdAt, updatedAt]
      properties:
        id:
          type: string
        title:
          type: string
        objective:
          type: string
        scope:
          type: string
        acceptanceCriteria:
          type: array
          items:
            type: string
        verificationCommands:
          type: array
          items:
            type: string
        assignedTo:
          type: string
        status:
          $ref: "#/components/schemas/TaskStatus"
        dependencies:
          type: array
          items:
            type: string
        parallelGroup:
          type: string
        workspaceId:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        completionSummary:
          type: string
        verificationVerdict:
          $ref: "#/components/schemas/VerificationVerdict"
        verificationReport:
          type: string

    NoteMetadata:
      type: object
      required: [type]
      properties:
        type:
          $ref: "#/components/schemas/NoteType"
        taskStatus:
          $ref: "#/components/schemas/TaskStatus"
        assignedAgentIds:
          type: array
          items:
            type: string
        parentNoteId:
          type: string
        linkedTaskId:
          type: string
        custom:
          type: object
          additionalProperties:
            type: string

    Note:
      type: object
      required: [id, title, content, workspaceId, metadata, createdAt, updatedAt]
      properties:
        id:
          type: string
        title:
          type: string
        content:
          type: string
        workspaceId:
          type: string
        metadata:
          $ref: "#/components/schemas/NoteMetadata"
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Workspace:
      type: object
      required: [id, title, status, metadata, createdAt, updatedAt]
      properties:
        id:
          type: string
        title:
          type: string
        repoPath:
          type: string
        branch:
          type: string
        status:
          $ref: "#/components/schemas/WorkspaceStatus"
        metadata:
          type: object
          additionalProperties:
            type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    # ── Common Response Shapes ──
    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: string

    DeletedResponse:
      type: object
      required: [deleted]
      properties:
        deleted:
          type: boolean
          const: true

# ─────────────────────────────────────────────────────────
# API Paths
# ─────────────────────────────────────────────────────────
paths:
  # ── Health ──
  /api/health:
    get:
      operationId: getHealth
      summary: Health check — returns service status
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                required: [status, timestamp]
                properties:
                  status:
                    type: string
                    example: ok
                  timestamp:
                    type: string
                    format: date-time

  # ── Agents ──
  /api/agents:
    get:
      operationId: listAgents
      summary: List agents (or get single by id query param)
      parameters:
        - name: id
          in: query
          schema:
            type: string
          description: If provided, returns single agent
        - name: workspaceId
          in: query
          schema:
            type: string
            default: "default"
        - name: role
          in: query
          schema:
            $ref: "#/components/schemas/AgentRole"
        - name: status
          in: query
          schema:
            $ref: "#/components/schemas/AgentStatus"
        - name: parentId
          in: query
          schema:
            type: string
        - name: summary
          in: query
          schema:
            type: string
          description: If present with id, returns agent summary (Next.js only)
      responses:
        "200":
          description: Agent list or single agent
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    properties:
                      agents:
                        type: array
                        items:
                          $ref: "#/components/schemas/Agent"
                  - $ref: "#/components/schemas/Agent"
    post:
      operationId: createAgent
      summary: Create a new agent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, role]
              properties:
                name:
                  type: string
                role:
                  $ref: "#/components/schemas/AgentRole"
                workspaceId:
                  type: string
                  default: "default"
                parentId:
                  type: string
                modelTier:
                  $ref: "#/components/schemas/ModelTier"
      responses:
        "200":
          description: Created agent
          content:
            application/json:
              schema:
                type: object
                properties:
                  agentId:
                    type: string
                  agent:
                    $ref: "#/components/schemas/Agent"

  /api/agents/{id}:
    get:
      operationId: getAgent
      summary: Get agent by ID (REST-style path param)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Single agent
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Agent"
        "404":
          description: Agent not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    delete:
      operationId: deleteAgent
      summary: Delete an agent
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeletedResponse"

  /api/agents/{id}/status:
    post:
      operationId: updateAgentStatus
      summary: Update agent status
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [status]
              properties:
                status:
                  $ref: "#/components/schemas/AgentStatus"
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  updated:
                    type: boolean
                    const: true

  # ── Tasks ──
  /api/tasks:
    get:
      operationId: listTasks
      summary: List tasks
      parameters:
        - name: workspaceId
          in: query
          schema:
            type: string
            default: "default"
        - name: status
          in: query
          schema:
            $ref: "#/components/schemas/TaskStatus"
        - name: assignedTo
          in: query
          schema:
            type: string
      responses:
        "200":
          description: Task list
          content:
            application/json:
              schema:
                type: object
                properties:
                  tasks:
                    type: array
                    items:
                      $ref: "#/components/schemas/Task"
    post:
      operationId: createTask
      summary: Create a task
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [title, objective]
              properties:
                title:
                  type: string
                objective:
                  type: string
                workspaceId:
                  type: string
                  default: "default"
                scope:
                  type: string
                acceptanceCriteria:
                  type: array
                  items:
                    type: string
                verificationCommands:
                  type: array
                  items:
                    type: string
                dependencies:
                  type: array
                  items:
                    type: string
                parallelGroup:
                  type: string
      responses:
        "200":
          description: Created task
          content:
            application/json:
              schema:
                type: object
                properties:
                  task:
                    $ref: "#/components/schemas/Task"
    delete:
      operationId: deleteAllTasks
      summary: Delete all tasks for a workspace
      parameters:
        - name: workspaceId
          in: query
          schema:
            type: string
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  deleted:
                    type: integer

  /api/tasks/{id}:
    get:
      operationId: getTask
      summary: Get task by ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Single task
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Task"
        "404":
          description: Task not found
    delete:
      operationId: deleteTask
      summary: Delete a task
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeletedResponse"

  /api/tasks/{id}/status:
    post:
      operationId: updateTaskStatus
      summary: Update task status
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [status]
              properties:
                status:
                  $ref: "#/components/schemas/TaskStatus"
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  updated:
                    type: boolean

  /api/tasks/ready:
    get:
      operationId: findReadyTasks
      summary: Find tasks with all dependencies satisfied
      parameters:
        - name: workspaceId
          in: query
          schema:
            type: string
            default: "default"
      responses:
        "200":
          description: Ready tasks
          content:
            application/json:
              schema:
                type: object
                properties:
                  tasks:
                    type: array
                    items:
                      $ref: "#/components/schemas/Task"

  # ── Notes ──
  /api/notes:
    get:
      operationId: listNotes
      summary: List notes or get single by noteId
      parameters:
        - name: workspaceId
          in: query
          schema:
            type: string
            default: "default"
        - name: type
          in: query
          schema:
            $ref: "#/components/schemas/NoteType"
        - name: noteId
          in: query
          schema:
            type: string
          description: If provided, returns single note
      responses:
        "200":
          description: Notes list or single note
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    properties:
                      notes:
                        type: array
                        items:
                          $ref: "#/components/schemas/Note"
                  - type: object
                    properties:
                      note:
                        $ref: "#/components/schemas/Note"
    post:
      operationId: createOrUpdateNote
      summary: Create or update a note
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [title]
              properties:
                noteId:
                  type: string
                title:
                  type: string
                content:
                  type: string
                workspaceId:
                  type: string
                  default: "default"
                type:
                  $ref: "#/components/schemas/NoteType"
                metadata:
                  $ref: "#/components/schemas/NoteMetadata"
      responses:
        "200":
          description: Created/updated note
          content:
            application/json:
              schema:
                type: object
                properties:
                  note:
                    $ref: "#/components/schemas/Note"
    delete:
      operationId: deleteNoteByQuery
      summary: Delete note by query params
      parameters:
        - name: noteId
          in: query
          required: true
          schema:
            type: string
        - name: workspaceId
          in: query
          schema:
            type: string
            default: "default"
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  deleted:
                    type: boolean
                    const: true
                  noteId:
                    type: string

  /api/notes/events:
    get:
      operationId: noteEventsSse
      summary: SSE stream for note change events
      parameters:
        - name: workspaceId
          in: query
          schema:
            type: string
      responses:
        "200":
          description: SSE stream
          content:
            text/event-stream: {}

  /api/notes/{workspaceId}/{noteId}:
    get:
      operationId: getNote
      summary: Get note by workspace + note ID
      parameters:
        - name: workspaceId
          in: path
          required: true
          schema:
            type: string
        - name: noteId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Single note
          content:
            application/json:
              schema:
                type: object
                properties:
                  note:
                    $ref: "#/components/schemas/Note"
    delete:
      operationId: deleteNotePath
      summary: Delete note by path params
      parameters:
        - name: workspaceId
          in: path
          required: true
          schema:
            type: string
        - name: noteId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  deleted:
                    type: boolean
                    const: true
                  noteId:
                    type: string

  # ── Workspaces ──
  /api/workspaces:
    get:
      operationId: listWorkspaces
      summary: List all workspaces
      responses:
        "200":
          description: Workspace list
          content:
            application/json:
              schema:
                type: object
                properties:
                  workspaces:
                    type: array
                    items:
                      $ref: "#/components/schemas/Workspace"
    post:
      operationId: createWorkspace
      summary: Create a workspace
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [title]
              properties:
                title:
                  type: string
                repoPath:
                  type: string
                branch:
                  type: string
                metadata:
                  type: object
                  additionalProperties:
                    type: string
      responses:
        "200":
          description: Created workspace
          content:
            application/json:
              schema:
                type: object
                properties:
                  workspace:
                    $ref: "#/components/schemas/Workspace"

  /api/workspaces/{id}:
    get:
      operationId: getWorkspace
      summary: Get workspace by ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Single workspace
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Workspace"
        "404":
          description: Workspace not found
    patch:
      operationId: updateWorkspace
      summary: Update workspace (title, repoPath, branch, status, metadata)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                repoPath:
                  type: string
                branch:
                  type: string
                status:
                  $ref: "#/components/schemas/WorkspaceStatus"
                metadata:
                  type: object
                  additionalProperties:
                    type: string
      responses:
        "200":
          description: Updated workspace
          content:
            application/json:
              schema:
                type: object
                properties:
                  workspace:
                    $ref: "#/components/schemas/Workspace"
    delete:
      operationId: deleteWorkspace
      summary: Delete workspace
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeletedResponse"

  # ── Skills ──
  /api/skills:
    get:
      operationId: listSkills
      summary: List skills or get by name
      parameters:
        - name: name
          in: query
          schema:
            type: string
      responses:
        "200":
          description: Skills list or single skill
          content:
            application/json:
              schema:
                type: object
                properties:
                  skills:
                    type: array
                    items:
                      type: object
    post:
      operationId: reloadSkills
      summary: Reload skills from disk
      responses:
        "200":
          description: Reloaded
          content:
            application/json:
              schema:
                type: object
                properties:
                  reloaded:
                    type: boolean
                    const: true

  /api/skills/clone:
    get:
      operationId: discoverSkills
      summary: Discover skills from repo path
      parameters:
        - name: repoPath
          in: query
          schema:
            type: string
      responses:
        "200":
          description: Discovered skills
    post:
      operationId: cloneSkillRepo
      summary: Clone a skill repository
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                url:
                  type: string
                skillsDir:
                  type: string
      responses:
        "200":
          description: Cloned

  /api/skills/upload:
    post:
      operationId: uploadSkillZip
      summary: Upload skill as zip
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
      responses:
        "200":
          description: Uploaded

  # ── Sessions ──
  /api/sessions:
    get:
      operationId: listSessions
      summary: List ACP sessions
      responses:
        "200":
          description: Session list
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessions:
                    type: array
                    items:
                      type: object

  # ── ACP ──
  /api/acp:
    post:
      operationId: acpRpc
      summary: ACP JSON-RPC endpoint
      description: |
        Methods: initialize, _providers/list, session/new, session/prompt,
        session/cancel, session/load, session/set_mode
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                jsonrpc:
                  type: string
                  const: "2.0"
                method:
                  type: string
                params:
                  type: object
                id:
                  oneOf:
                    - type: string
                    - type: number
      responses:
        "200":
          description: JSON-RPC response
    get:
      operationId: acpSse
      summary: ACP SSE stream
      parameters:
        - name: sessionId
          in: query
          schema:
            type: string
      responses:
        "200":
          description: SSE stream
          content:
            text/event-stream: {}

  # ── MCP ──
  /api/mcp:
    post:
      operationId: mcpPost
      summary: MCP Streamable HTTP (JSON-RPC)
      description: |
        Methods: initialize, tools/list, tools/call, notifications/initialized
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: JSON-RPC response
    get:
      operationId: mcpGet
      summary: MCP SSE stream
      responses:
        "200":
          description: SSE stream
          content:
            text/event-stream: {}
    delete:
      operationId: mcpDelete
      summary: Terminate MCP session
      responses:
        "200":
          description: Terminated

  /api/mcp/tools:
    get:
      operationId: listMcpTools
      summary: List MCP tools
      responses:
        "200":
          description: Tools list
    post:
      operationId: executeMcpTool
      summary: Execute an MCP tool
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                args:
                  type: object
      responses:
        "200":
          description: Tool result
    patch:
      operationId: updateMcpToolsConfig
      summary: Update MCP tool configuration
      requestBody:
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Updated config

  /api/mcp-server:
    get:
      operationId: mcpServerStatus
      summary: Get MCP server status
      responses:
        "200":
          description: Status
    post:
      operationId: mcpServerStart
      summary: Start MCP server
      responses:
        "200":
          description: Started
    delete:
      operationId: mcpServerStop
      summary: Stop MCP server
      responses:
        "200":
          description: Stopped

  # ── Custom MCP Servers ──
  /api/mcp-servers:
    get:
      operationId: listCustomMcpServers
      summary: List custom MCP servers (or get single by id query param)
      parameters:
        - name: id
          in: query
          schema:
            type: string
          description: If provided, returns single server
        - name: workspaceId
          in: query
          schema:
            type: string
      responses:
        "200":
          description: Servers list or single server
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    properties:
                      servers:
                        type: array
                        items:
                          type: object
                  - type: object
                    description: Single server object
        "404":
          description: Server not found (when id is provided)
    post:
      operationId: createCustomMcpServer
      summary: Create a new custom MCP server
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [id, name, type]
              properties:
                id:
                  type: string
                name:
                  type: string
                description:
                  type: string
                type:
                  type: string
                  enum: [stdio, http, sse]
                command:
                  type: string
                args:
                  type: array
                  items:
                    type: string
                url:
                  type: string
                headers:
                  type: object
                env:
                  type: object
                enabled:
                  type: boolean
                  default: true
                workspaceId:
                  type: string
      responses:
        "200":
          description: Created
          content:
            application/json:
              schema:
                type: object
                properties:
                  server:
                    type: object
                  message:
                    type: string
    put:
      operationId: updateCustomMcpServer
      summary: Update an existing custom MCP server
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: string
                name:
                  type: string
                description:
                  type: string
                type:
                  type: string
                  enum: [stdio, http, sse]
                command:
                  type: string
                args:
                  type: array
                  items:
                    type: string
                url:
                  type: string
                headers:
                  type: object
                env:
                  type: object
                enabled:
                  type: boolean
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  server:
                    type: object
                  message:
                    type: string
        "404":
          description: Server not found
    delete:
      operationId: deleteCustomMcpServer
      summary: Delete a custom MCP server
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        "404":
          description: Server not found

  /api/test-mcp:
    get:
      operationId: testMcp
      summary: Test MCP config
      responses:
        "200":
          description: Config

  # ── Clone ──
  /api/clone:
    get:
      operationId: listClonedRepos
      summary: List cloned repositories
      responses:
        "200":
          description: Repo list
          content:
            application/json:
              schema:
                type: object
                properties:
                  repos:
                    type: array
                    items:
                      type: object
    post:
      operationId: cloneRepo
      summary: Clone a GitHub repository
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [url]
              properties:
                url:
                  type: string
      responses:
        "200":
          description: Cloned
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  path:
                    type: string
                  name:
                    type: string
                  branch:
                    type: string
                  branches:
                    type: array
                    items:
                      type: string
                  existed:
                    type: boolean
    patch:
      operationId: switchBranch
      summary: Switch branch on cloned repo
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [repoPath, branch]
              properties:
                repoPath:
                  type: string
                branch:
                  type: string
      responses:
        "200":
          description: Switched
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  branch:
                    type: string
                  branches:
                    type: array
                    items:
                      type: string

  /api/clone/progress:
    post:
      operationId: cloneWithProgress
      summary: Clone with SSE progress
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                url:
                  type: string
      responses:
        "200":
          description: SSE progress stream
          content:
            text/event-stream: {}

  /api/clone/branches:
    get:
      operationId: getBranches
      summary: Get branch info
      parameters:
        - name: repoPath
          in: query
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Branch info
    post:
      operationId: fetchBranches
      summary: Fetch remote branches
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                repoPath:
                  type: string
      responses:
        "200":
          description: Fetched
    patch:
      operationId: checkoutBranch
      summary: Checkout branch
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                repoPath:
                  type: string
                branch:
                  type: string
                pull:
                  type: boolean
      responses:
        "200":
          description: Checked out

  # ── A2A ──
  /api/a2a/sessions:
    get:
      operationId: listA2aSessions
      summary: List A2A sessions
      responses:
        "200":
          description: Sessions

  /api/a2a/card:
    get:
      operationId: getAgentCard
      summary: A2A agent card
      responses:
        "200":
          description: Agent card

  /api/a2a/rpc:
    post:
      operationId: a2aRpc
      summary: A2A JSON-RPC
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: JSON-RPC response
    get:
      operationId: a2aRpcSse
      summary: A2A SSE stream
      parameters:
        - name: sessionId
          in: query
          schema:
            type: string
      responses:
        "200":
          description: SSE stream
          content:
            text/event-stream: {}

  # ── GitHub Virtual Workspace ──
  /api/github:
    get:
      operationId: listGitHubWorkspaces
      summary: List active GitHub virtual workspaces
      responses:
        "200":
          description: Active workspaces
          content:
            application/json:
              schema:
                type: object
                properties:
                  workspaces:
                    type: array
                    items:
                      type: object
                      properties:
                        key:
                          type: string
                        owner:
                          type: string
                        repo:
                          type: string
                        ref:
                          type: string
                        fileCount:
                          type: integer
                        importedAt:
                          type: string
                          format: date-time
                        expiresAt:
                          type: string
                          format: date-time

  /api/github/import:
    post:
      operationId: importGitHubRepo
      summary: Import a GitHub repo as a virtual workspace (zipball download)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                owner:
                  type: string
                repo:
                  type: string
                ref:
                  type: string
                  description: Branch, tag, or SHA. Defaults to HEAD.
                url:
                  type: string
                  description: Shorthand — GitHub URL (parsed into owner/repo)
      responses:
        "200":
          description: Import successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  owner:
                    type: string
                  repo:
                    type: string
                  ref:
                    type: string
                  fileCount:
                    type: integer
                  extractedPath:
                    type: string
                  importedAt:
                    type: string
                    format: date-time
        "404":
          description: Repository not found
        "403":
          description: Rate limited or forbidden
        "413":
          description: Repository too large

  /api/github/tree:
    get:
      operationId: getGitHubTree
      summary: Get file tree for an imported GitHub repo
      parameters:
        - name: owner
          in: query
          required: true
          schema:
            type: string
        - name: repo
          in: query
          required: true
          schema:
            type: string
        - name: ref
          in: query
          schema:
            type: string
            default: HEAD
      responses:
        "200":
          description: File tree
          content:
            application/json:
              schema:
                type: object
                properties:
                  tree:
                    type: array
                    items:
                      $ref: "#/components/schemas/VirtualFileEntry"
                  fileCount:
                    type: integer
        "404":
          description: Workspace not imported

  /api/github/file:
    get:
      operationId: getGitHubFile
      summary: Read a file from an imported GitHub repo
      parameters:
        - name: owner
          in: query
          required: true
          schema:
            type: string
        - name: repo
          in: query
          required: true
          schema:
            type: string
        - name: path
          in: query
          required: true
          schema:
            type: string
        - name: ref
          in: query
          schema:
            type: string
            default: HEAD
      responses:
        "200":
          description: File content
          content:
            application/json:
              schema:
                type: object
                properties:
                  content:
                    type: string
                  path:
                    type: string
        "404":
          description: File or workspace not found

  /api/github/search:
    get:
      operationId: searchGitHubFiles
      summary: Search files in an imported GitHub repo
      parameters:
        - name: owner
          in: query
          required: true
          schema:
            type: string
        - name: repo
          in: query
          required: true
          schema:
            type: string
        - name: q
          in: query
          schema:
            type: string
        - name: ref
          in: query
          schema:
            type: string
            default: HEAD
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
      responses:
        "200":
          description: Search results
          content:
            application/json:
              schema:
                type: object
                properties:
                  files:
                    type: array
                    items:
                      type: object
                      properties:
                        path:
                          type: string
                        name:
                          type: string
                        score:
                          type: number
                  total:
                    type: integer
                  query:
                    type: string

  # ── Workspace sub-resources ──
  /api/workspaces/{id}/archive:
    post:
      operationId: archiveWorkspace
      summary: Archive or unarchive a workspace
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                archive:
                  type: boolean
      responses:
        "200":
          description: Updated workspace
          content:
            application/json:
              schema:
                type: object
                properties:
                  workspace:
                    $ref: "#/components/schemas/Workspace"

  /api/workspaces/{id}/codebases:
    get:
      operationId: listWorkspaceCodebases
      summary: List codebases in a workspace
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Codebase list
          content:
            application/json:
              schema:
                type: object
                properties:
                  codebases:
                    type: array
                    items:
                      type: object
    post:
      operationId: addWorkspaceCodebase
      summary: Add a codebase to a workspace
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                path:
                  type: string
                sourceType:
                  $ref: "#/components/schemas/CodebaseSourceType"
      responses:
        "200":
          description: Created codebase

  # ── Codebases ──
  /api/codebases/{id}:
    patch:
      operationId: updateCodebase
      summary: Update codebase metadata
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Updated
    delete:
      operationId: deleteCodebase
      summary: Delete a codebase
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeletedResponse"

  /api/codebases/{id}/default:
    post:
      operationId: setDefaultCodebase
      summary: Set a codebase as the default
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Updated

  # ── Skills catalog ──
  /api/skills/catalog:
    get:
      operationId: listSkillCatalog
      summary: List available skills in the registry
      responses:
        "200":
          description: Skill catalog
          content:
            application/json:
              schema:
                type: object
                properties:
                  skills:
                    type: array
                    items:
                      type: object
    post:
      operationId: refreshSkillCatalog
      summary: Refresh the local skill catalog from registry
      responses:
        "200":
          description: Refreshed catalog

  # ── Providers ──
  /api/providers:
    get:
      operationId: listProviders
      summary: List configured LLM providers
      responses:
        "200":
          description: Provider list
          content:
            application/json:
              schema:
                type: object
                properties:
                  providers:
                    type: array
                    items:
                      type: object

  /api/providers/models:
    get:
      operationId: listProviderModels
      summary: List available models for configured providers
      parameters:
        - name: provider
          in: query
          schema:
            type: string
      responses:
        "200":
          description: Model list
          content:
            application/json:
              schema:
                type: object
                properties:
                  models:
                    type: array
                    items:
                      type: object

  # ── ACP sub-routes ──
  /api/acp/registry:
    get:
      operationId: listAcpRegistry
      summary: List agents in the ACP registry
      responses:
        "200":
          description: Registry entries
    post:
      operationId: registerAcpAgent
      summary: Register an agent in the ACP registry
      requestBody:
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Registered

  /api/acp/install:
    post:
      operationId: installAcpAgent
      summary: Install an ACP agent
      requestBody:
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Installed
    delete:
      operationId: uninstallAcpAgent
      summary: Uninstall an ACP agent
      responses:
        "200":
          description: Uninstalled

  /api/acp/runtime:
    get:
      operationId: getAcpRuntime
      summary: Get ACP runtime status
      responses:
        "200":
          description: Runtime status
    post:
      operationId: startAcpRuntime
      summary: Start ACP runtime
      responses:
        "200":
          description: Started

  /api/acp/warmup:
    get:
      operationId: getAcpWarmupStatus
      summary: Get ACP warmup status
      responses:
        "200":
          description: Warmup status
    post:
      operationId: triggerAcpWarmup
      summary: Trigger ACP warmup
      responses:
        "200":
          description: Warmup triggered

  # ── Files ──
  /api/files/search:
    get:
      operationId: searchFiles
      summary: Search files in a codebase
      parameters:
        - name: workspaceId
          in: query
          schema:
            type: string
        - name: codebaseId
          in: query
          schema:
            type: string
        - name: q
          in: query
          schema:
            type: string
      responses:
        "200":
          description: File search results
          content:
            application/json:
              schema:
                type: object

  # ── RPC ──
  /api/rpc:
    post:
      operationId: rpcCall
      summary: Generic JSON-RPC endpoint
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [method]
              properties:
                method:
                  type: string
                params:
                  type: object
      responses:
        "200":
          description: RPC result

  # ── Traces ──
  /api/traces:
    get:
      operationId: listTraces
      summary: List agent execution traces
      parameters:
        - name: workspaceId
          in: query
          schema:
            type: string
        - name: agentId
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
      responses:
        "200":
          description: Trace list
          content:
            application/json:
              schema:
                type: object
                properties:
                  traces:
                    type: array
                    items:
                      type: object
    post:
      operationId: createTrace
      summary: Create a new trace record
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Created trace

  /api/traces/stats:
    get:
      operationId: getTraceStats
      summary: Get aggregated trace statistics
      parameters:
        - name: workspaceId
          in: query
          schema:
            type: string
      responses:
        "200":
          description: Trace statistics
          content:
            application/json:
              schema:
                type: object

  /api/traces/{id}:
    get:
      operationId: getTrace
      summary: Get a single trace by ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Trace detail

  # ── Schedules ──
  /api/schedules:
    get:
      operationId: listSchedules
      summary: List scheduled tasks
      parameters:
        - name: workspaceId
          in: query
          schema:
            type: string
      responses:
        "200":
          description: Schedule list
          content:
            application/json:
              schema:
                type: object
                properties:
                  schedules:
                    type: array
                    items:
                      type: object
    post:
      operationId: createSchedule
      summary: Create a new schedule
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, cron]
              properties:
                name:
                  type: string
                cron:
                  type: string
                workspaceId:
                  type: string
                enabled:
                  type: boolean
      responses:
        "200":
          description: Created schedule

  /api/schedules/{id}:
    get:
      operationId: getSchedule
      summary: Get a schedule by ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Schedule detail
    patch:
      operationId: updateSchedule
      summary: Update a schedule
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Updated schedule
    delete:
      operationId: deleteSchedule
      summary: Delete a schedule
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeletedResponse"

  # ── Specialists ──
  /api/specialists:
    get:
      operationId: listSpecialists
      summary: List configured specialist agents
      parameters:
        - name: workspaceId
          in: query
          schema:
            type: string
      responses:
        "200":
          description: Specialist list
          content:
            application/json:
              schema:
                type: object
                properties:
                  specialists:
                    type: array
                    items:
                      type: object
    post:
      operationId: createSpecialist
      summary: Create a specialist configuration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Created specialist
    put:
      operationId: updateSpecialist
      summary: Update an existing specialist
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Updated specialist
    delete:
      operationId: deleteSpecialist
      summary: Delete a specialist
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeletedResponse"

  # ── Memory ──
  /api/memory:
    get:
      operationId: listMemory
      summary: List memory entries for a workspace
      parameters:
        - name: workspaceId
          in: query
          schema:
            type: string
      responses:
        "200":
          description: Memory entries
          content:
            application/json:
              schema:
                type: object
                properties:
                  entries:
                    type: array
                    items:
                      type: object
    post:
      operationId: createMemoryEntry
      summary: Create a memory entry
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Created entry
    delete:
      operationId: deleteMemoryEntry
      summary: Delete memory entries
      parameters:
        - name: workspaceId
          in: query
          schema:
            type: string
        - name: id
          in: query
          schema:
            type: string
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeletedResponse"

  # ── Polling ──
  /api/polling/config:
    get:
      operationId: getPollingConfig
      summary: Get polling configuration
      responses:
        "200":
          description: Polling config
    post:
      operationId: updatePollingConfig
      summary: Update polling configuration
      requestBody:
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Updated config

  /api/polling/check:
    get:
      operationId: pollCheck
      summary: Run a polling check (GET)
      responses:
        "200":
          description: Poll result
    post:
      operationId: pollCheckPost
      summary: Run a polling check (POST)
      requestBody:
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Poll result

  # ── Sessions (by ID) ──
  /api/sessions/{id}:
    get:
      operationId: getSession
      summary: Get session by ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Session detail
    patch:
      operationId: updateSession
      summary: Update session metadata
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Updated session
    delete:
      operationId: deleteSession
      summary: Delete a session
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeletedResponse"

  /api/sessions/{id}/history:
    get:
      operationId: getSessionHistory
      summary: Get message history for a session
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Session history
          content:
            application/json:
              schema:
                type: object
                properties:
                  messages:
                    type: array
                    items:
                      type: object

  # ── Background Tasks ──
  /api/background-tasks:
    get:
      operationId: listBackgroundTasks
      summary: List background tasks
      parameters:
        - name: workspaceId
          in: query
          schema:
            type: string
        - name: status
          in: query
          schema:
            type: string
      responses:
        "200":
          description: Background task list
          content:
            application/json:
              schema:
                type: object
    post:
      operationId: createBackgroundTask
      summary: Create a background task
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Created task

  /api/background-tasks/process:
    post:
      operationId: processBackgroundTasks
      summary: Process the next pending background task
      responses:
        "200":
          description: Processing result

  /api/background-tasks/{id}:
    get:
      operationId: getBackgroundTask
      summary: Get a background task by ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Task detail
    delete:
      operationId: cancelBackgroundTask
      summary: Cancel a background task
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeletedResponse"

  /api/background-tasks/{id}/retry:
    post:
      operationId: retryBackgroundTask
      summary: Retry a failed background task
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Retry queued

  # ── Schedules sub-operations ──
  /api/schedules/{id}/run:
    post:
      operationId: runScheduleNow
      summary: Trigger a schedule to run immediately
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Triggered

  /api/schedules/tick:
    get:
      operationId: getScheduleTick
      summary: Get tick status for scheduled tasks
      responses:
        "200":
          description: Tick status
    post:
      operationId: triggerScheduleTick
      summary: Manually trigger the schedule tick
      responses:
        "200":
          description: Tick triggered

  # ── Webhooks ──
  /api/webhooks/configs:
    get:
      operationId: listWebhookConfigs
      summary: List webhook configurations
      responses:
        "200":
          description: Webhook config list
    post:
      operationId: createWebhookConfig
      summary: Create a webhook configuration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Created config
    put:
      operationId: updateWebhookConfig
      summary: Update a webhook configuration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Updated config
    delete:
      operationId: deleteWebhookConfig
      summary: Delete a webhook configuration
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeletedResponse"

  /api/webhooks/github:
    get:
      operationId: listGithubWebhooks
      summary: List registered GitHub webhooks
      responses:
        "200":
          description: Webhook list
    post:
      operationId: handleGithubWebhook
      summary: Handle an incoming GitHub webhook event
      requestBody:
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Processed

  /api/webhooks/register:
    get:
      operationId: listWebhookRegistrations
      summary: List webhook registrations
      responses:
        "200":
          description: Registration list
    post:
      operationId: registerWebhook
      summary: Register a new webhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Registered
    delete:
      operationId: unregisterWebhook
      summary: Unregister a webhook
      responses:
        "200":
          description: Unregistered

  /api/webhooks/webhook-logs:
    get:
      operationId: listWebhookLogs
      summary: List webhook delivery logs
      parameters:
        - name: workspaceId
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
      responses:
        "200":
          description: Webhook logs

  # ── GitHub utility ──
  /api/github/pr-comment:
    post:
      operationId: postGithubPrComment
      summary: Post a comment on a GitHub pull request
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [owner, repo, prNumber, body]
              properties:
                owner:
                  type: string
                repo:
                  type: string
                prNumber:
                  type: integer
                body:
                  type: string
      responses:
        "200":
          description: Comment posted

  # ── A2A Protocol ──
  /api/a2a/message:
    post:
      operationId: sendA2AMessage
      summary: Send a message via the A2A protocol
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Message sent

  /api/a2a/tasks:
    get:
      operationId: listA2ATasks
      summary: List A2A tasks
      responses:
        "200":
          description: Task list

  /api/a2a/tasks/{id}:
    get:
      operationId: getA2ATask
      summary: Get an A2A task by ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Task detail
    post:
      operationId: updateA2ATask
      summary: Update / respond to an A2A task
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Updated

  # ── RPC discovery (Rust) ──
  /api/rpc/methods:
    get:
      operationId: listRpcMethods
      summary: List available RPC methods
      responses:
        "200":
          description: RPC method list
          content:
            application/json:
              schema:
                type: object
                properties:
                  methods:
                    type: array
                    items:
                      type: string
